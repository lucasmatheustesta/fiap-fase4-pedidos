name: ğŸ” PR Quality Check

on:
  pull_request:
    branches: [ main, master ]
    types: [opened, synchronize, reopened, ready_for_review]

env:
  PYTHON_VERSION: '3.11'
  MINIMUM_COVERAGE: 70

jobs:
  # Job obrigatÃ³rio: VerificaÃ§Ã£o de Qualidade
  quality-gate:
    name: ğŸšª Quality Gate
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    outputs:
      coverage-percentage: ${{ steps.coverage.outputs.percentage }}
      quality-passed: ${{ steps.quality-check.outputs.passed }}
    
    steps:
    - name: ğŸ“¥ Checkout PR code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: ${{ github.event.pull_request.head.sha }}
    
    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-html coverage
        pip install flake8 black isort bandit safety
    
    - name: ğŸ§ª Run tests with coverage
      id: tests
      run: |
        echo "ğŸ§ª Running unit tests..."
        python -m pytest tests/unit/ \
          --cov=src \
          --cov-report=xml:coverage.xml \
          --cov-report=term-missing \
          --cov-report=html:htmlcov \
          --junitxml=test-results.xml \
          --html=test-report.html \
          --self-contained-html \
          -v
        
        echo "âœ… Tests completed"
    
    - name: ğŸ“Š Extract coverage percentage
      id: coverage
      run: |
        COVERAGE=$(python -c "
        import xml.etree.ElementTree as ET
        try:
            tree = ET.parse('coverage.xml')
            root = tree.getroot()
            coverage = float(root.attrib['line-rate']) * 100
            print(f'{coverage:.1f}')
        except Exception as e:
            print('0.0')
        ")
        
        echo "percentage=$COVERAGE" >> $GITHUB_OUTPUT
        echo "ğŸ“Š Coverage: $COVERAGE%"
        
        if (( $(echo "$COVERAGE >= $MINIMUM_COVERAGE" | bc -l) )); then
          echo "âœ… Coverage meets minimum requirement ($MINIMUM_COVERAGE%)"
          echo "coverage-status=âœ… PASSED" >> $GITHUB_OUTPUT
        else
          echo "âŒ Coverage below minimum requirement ($MINIMUM_COVERAGE%)"
          echo "coverage-status=âŒ FAILED" >> $GITHUB_OUTPUT
          exit 1
        fi
    
    - name: ğŸ¨ Code formatting check
      id: formatting
      run: |
        echo "ğŸ¨ Checking code formatting..."
        
        # Check Black formatting
        if black --check --diff src/ tests/; then
          echo "âœ… Code formatting is correct"
          echo "formatting-status=âœ… PASSED" >> $GITHUB_OUTPUT
        else
          echo "âŒ Code formatting issues found"
          echo "formatting-status=âŒ FAILED" >> $GITHUB_OUTPUT
          echo "Run 'black src/ tests/' to fix formatting"
        fi
    
    - name: ğŸ” Linting check
      id: linting
      run: |
        echo "ğŸ” Running linting checks..."
        
        # Flake8 linting
        if flake8 src/ tests/ --max-line-length=88 --extend-ignore=E203,W503; then
          echo "âœ… Linting passed"
          echo "linting-status=âœ… PASSED" >> $GITHUB_OUTPUT
        else
          echo "âŒ Linting issues found"
          echo "linting-status=âŒ FAILED" >> $GITHUB_OUTPUT
        fi
    
    - name: ğŸ”’ Security check
      id: security
      run: |
        echo "ğŸ”’ Running security checks..."
        
        # Bandit security check
        bandit -r src/ -f json -o bandit-report.json || true
        
        # Safety check for dependencies
        safety check || true
        
        echo "security-status=âœ… COMPLETED" >> $GITHUB_OUTPUT
        echo "âœ… Security scan completed"
    
    - name: ğŸ“Š Quality summary
      id: quality-check
      run: |
        echo "## ğŸ“Š Quality Check Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Check | Status | Details |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|---------|" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ§ª Tests | âœ… PASSED | All unit tests passed |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ“Š Coverage | ${{ steps.coverage.outputs.coverage-status }} | ${{ steps.coverage.outputs.percentage }}% (min: ${{ env.MINIMUM_COVERAGE }}%) |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ¨ Formatting | ${{ steps.formatting.outputs.formatting-status }} | Black code formatting |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ” Linting | ${{ steps.linting.outputs.linting-status }} | Flake8 linting |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ”’ Security | ${{ steps.security.outputs.security-status }} | Bandit + Safety |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Verificar se todos os checks passaram
        COVERAGE_OK=$(echo "${{ steps.coverage.outputs.percentage }} >= $MINIMUM_COVERAGE" | bc -l)
        
        if [[ "$COVERAGE_OK" == "1" ]]; then
          echo "âœ… All quality checks passed!" >> $GITHUB_STEP_SUMMARY
          echo "passed=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ Quality checks failed!" >> $GITHUB_STEP_SUMMARY
          echo "passed=false" >> $GITHUB_OUTPUT
          exit 1
        fi
    
    - name: ğŸ“¤ Upload artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: pr-quality-reports
        path: |
          coverage.xml
          htmlcov/
          test-results.xml
          test-report.html
          bandit-report.json
        retention-days: 30

  # Job: ComentÃ¡rio no PR
  pr-comment:
    name: ğŸ’¬ PR Comment
    runs-on: ubuntu-latest
    needs: quality-gate
    if: always()
    
    steps:
    - name: ğŸ’¬ Comment PR - Success
      if: needs.quality-gate.result == 'success'
      uses: actions/github-script@v7
      with:
        script: |
          const coverage = '${{ needs.quality-gate.outputs.coverage-percentage }}';
          const comment = `## âœ… Quality Check Passed!
          
          ğŸ‰ **All quality gates passed successfully!**
          
          ### ğŸ“Š Results Summary:
          - âœ… **Tests**: All unit tests passed
          - âœ… **Coverage**: ${coverage}% (minimum: ${{ env.MINIMUM_COVERAGE }}%)
          - âœ… **Code Quality**: All checks passed
          - âœ… **Security**: No critical issues found
          
          ### ğŸš€ Ready to merge!
          This PR meets all quality requirements and can be safely merged.
          
          ---
          *Automated quality check by GitHub Actions*`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
    
    - name: ğŸ’¬ Comment PR - Failure
      if: needs.quality-gate.result == 'failure'
      uses: actions/github-script@v7
      with:
        script: |
          const coverage = '${{ needs.quality-gate.outputs.coverage-percentage }}' || '0.0';
          const comment = `## âŒ Quality Check Failed!
          
          ğŸš« **This PR does not meet the quality requirements.**
          
          ### ğŸ“Š Results Summary:
          - ğŸ“Š **Coverage**: ${coverage}% (minimum required: ${{ env.MINIMUM_COVERAGE }}%)
          - âŒ **Quality Gates**: One or more checks failed
          
          ### ğŸ”§ Actions Required:
          1. **Increase test coverage** to at least ${{ env.MINIMUM_COVERAGE }}%
          2. **Fix code quality issues** (check the Actions logs)
          3. **Address security concerns** if any
          4. **Fix formatting issues** by running \`black src/ tests/\`
          
          ### ğŸ“‹ How to fix:
          \`\`\`bash
          # Run tests locally
          python -m pytest tests/unit/ --cov=src --cov-report=term-missing
          
          # Fix formatting
          black src/ tests/
          isort src/ tests/
          
          # Check linting
          flake8 src/ tests/
          \`\`\`
          
          ---
          *This PR will be blocked until all quality requirements are met.*`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

  # Job: Status Check (obrigatÃ³rio para merge)
  status-check:
    name: âœ… Status Check
    runs-on: ubuntu-latest
    needs: quality-gate
    if: always()
    
    steps:
    - name: âœ… Set success status
      if: needs.quality-gate.result == 'success'
      run: |
        echo "âœ… All quality checks passed!"
        echo "PR is ready for review and merge."
    
    - name: âŒ Set failure status
      if: needs.quality-gate.result == 'failure'
      run: |
        echo "âŒ Quality checks failed!"
        echo "PR cannot be merged until issues are resolved."
        exit 1

