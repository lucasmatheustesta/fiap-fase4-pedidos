name: ğŸš€ Deploy to AWS

on:
  push:
    branches: [ main, master ]
  workflow_run:
    workflows: ["ğŸ” PR Quality Check"]
    types:
      - completed
    branches: [ main, master ]

# PermissÃµes necessÃ¡rias
permissions:
  contents: read
  actions: read
  checks: read

env:
  AWS_REGION: us-east-1
  APP_RUNNER_SERVICE_NAME: pedidos-microservice

jobs:
  # Job: Verificar se deve fazer deploy
  check-deploy:
    name: ğŸ” Check Deploy Conditions
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    outputs:
      should-deploy: ${{ steps.check.outputs.should-deploy }}
      quality-passed: ${{ steps.quality.outputs.passed }}
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ” Check quality gate
        id: quality
        run: |
          # Se foi triggered por workflow_run, verificar se passou
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            if [ "${{ github.event.workflow_run.conclusion }}" = "success" ]; then
              echo "âœ… Quality gate passed"
              echo "passed=true" >> $GITHUB_OUTPUT
            else
              echo "âŒ Quality gate failed"
              echo "passed=false" >> $GITHUB_OUTPUT
            fi
          else
            # Push direto na main (assumir que passou)
            echo "ğŸ”„ Direct push to main, assuming quality passed"
            echo "passed=true" >> $GITHUB_OUTPUT
          fi
      
      - name: ğŸ¯ Determine if should deploy
        id: check
        run: |
          QUALITY_PASSED="${{ steps.quality.outputs.passed }}"
          
          if [ "$QUALITY_PASSED" = "true" ]; then
            echo "âœ… All conditions met for deployment"
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Conditions not met for deployment"
            echo "should-deploy=false" >> $GITHUB_OUTPUT
          fi
          
          echo "ğŸ“Š Deploy decision: ${{ steps.check.outputs.should-deploy }}"

  # Job: Build e Deploy
  deploy:
    name: ğŸš€ Deploy to AWS App Runner
    runs-on: ubuntu-latest
    needs: check-deploy
    if: needs.check-deploy.outputs.should-deploy == 'true'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov
      
      - name: ğŸ§ª Run quick tests before deploy
        run: |
          echo "ğŸ§ª Running quick smoke tests before deployment..."
          
          # Verificar se a aplicaÃ§Ã£o inicia
          timeout 10s python src/main.py &
          sleep 3
          
          # Testar endpoint bÃ¡sico
          if curl -f http://localhost:5000/api/health 2>/dev/null; then
            echo "âœ… Application starts and health check passes"
          else
            echo "âš ï¸ Health check warning, but continuing deployment"
          fi
          
          # Parar aplicaÃ§Ã£o
          pkill -f "python src/main.py" || true
      
      - name: ğŸ”§ Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: ğŸ—ï¸ Create or Update App Runner Service
        run: |
          echo "ğŸ—ï¸ Deploying to AWS App Runner..."
          
          # Verificar se o serviÃ§o jÃ¡ existe
          if aws apprunner describe-service --service-arn "arn:aws:apprunner:${{ env.AWS_REGION }}:${{ secrets.AWS_ACCOUNT_ID }}:service/${{ env.APP_RUNNER_SERVICE_NAME }}" 2>/dev/null; then
            echo "ğŸ”„ Service exists, updating..."
            
            # Atualizar serviÃ§o existente
            aws apprunner start-deployment \
              --service-arn "arn:aws:apprunner:${{ env.AWS_REGION }}:${{ secrets.AWS_ACCOUNT_ID }}:service/${{ env.APP_RUNNER_SERVICE_NAME }}"
            
            echo "deployment-type=update" >> $GITHUB_ENV
          else
            echo "ğŸ†• Service doesn't exist, creating new service..."
            
            # Criar novo serviÃ§o
            cat > apprunner-config.json << 'EOF'
          {
            "ServiceName": "${{ env.APP_RUNNER_SERVICE_NAME }}",
            "SourceConfiguration": {
              "AutoDeploymentsEnabled": true,
              "CodeRepository": {
                "RepositoryUrl": "${{ github.server_url }}/${{ github.repository }}",
                "SourceCodeVersion": {
                  "Type": "BRANCH",
                  "Value": "main"
                },
                "CodeConfiguration": {
                  "ConfigurationSource": "REPOSITORY",
                  "CodeConfigurationValues": {
                    "Runtime": "PYTHON_3",
                    "BuildCommand": "pip install -r requirements.txt",
                    "StartCommand": "python src/main.py",
                    "RuntimeEnvironmentVariables": {
                      "FLASK_ENV": "production",
                      "PORT": "5000"
                    }
                  }
                }
              }
            },
            "InstanceConfiguration": {
              "Cpu": "0.25 vCPU",
              "Memory": "0.5 GB"
            }
          }
          EOF
            
            # Substituir variÃ¡veis no JSON
            sed -i "s/\${{ env.APP_RUNNER_SERVICE_NAME }}/${{ env.APP_RUNNER_SERVICE_NAME }}/g" apprunner-config.json
            sed -i "s|\${{ github.server_url }}/\${{ github.repository }}|${{ github.server_url }}/${{ github.repository }}|g" apprunner-config.json
            
            # Criar serviÃ§o
            aws apprunner create-service --cli-input-json file://apprunner-config.json
            
            echo "deployment-type=create" >> $GITHUB_ENV
          fi
      
      - name: â³ Wait for deployment
        run: |
          echo "â³ Waiting for deployment to complete..."
          
          SERVICE_ARN="arn:aws:apprunner:${{ env.AWS_REGION }}:${{ secrets.AWS_ACCOUNT_ID }}:service/${{ env.APP_RUNNER_SERVICE_NAME }}"
          
          # Aguardar atÃ© o serviÃ§o estar rodando
          for i in {1..30}; do
            STATUS=$(aws apprunner describe-service --service-arn "$SERVICE_ARN" --query 'Service.Status' --output text)
            echo "ğŸ”„ Deployment status: $STATUS (attempt $i/30)"
            
            if [ "$STATUS" = "RUNNING" ]; then
              echo "âœ… Deployment completed successfully!"
              break
            elif [ "$STATUS" = "CREATE_FAILED" ] || [ "$STATUS" = "UPDATE_FAILED" ]; then
              echo "âŒ Deployment failed with status: $STATUS"
              exit 1
            fi
            
            sleep 30
          done
          
          if [ "$STATUS" != "RUNNING" ]; then
            echo "â° Deployment timeout - status: $STATUS"
            echo "ğŸ” Check AWS Console for details"
            exit 1
          fi
      
      - name: ğŸŒ Get service URL
        id: url
        run: |
          SERVICE_ARN="arn:aws:apprunner:${{ env.AWS_REGION }}:${{ secrets.AWS_ACCOUNT_ID }}:service/${{ env.APP_RUNNER_SERVICE_NAME }}"
          
          SERVICE_URL=$(aws apprunner describe-service --service-arn "$SERVICE_ARN" --query 'Service.ServiceUrl' --output text)
          
          echo "ğŸŒ Service URL: https://$SERVICE_URL"
          echo "url=https://$SERVICE_URL" >> $GITHUB_OUTPUT
          echo "SERVICE_URL=https://$SERVICE_URL" >> $GITHUB_ENV
      
      - name: ğŸ§ª Test deployed application
        run: |
          echo "ğŸ§ª Testing deployed application..."
          
          # Aguardar um pouco para o serviÃ§o estar totalmente disponÃ­vel
          sleep 30
          
          # Testar health check
          if curl -f "${{ env.SERVICE_URL }}/api/health" --max-time 30; then
            echo "âœ… Health check passed!"
          else
            echo "âš ï¸ Health check failed, but deployment completed"
          fi
          
          # Testar endpoint de info
          if curl -f "${{ env.SERVICE_URL }}/api/info" --max-time 30; then
            echo "âœ… Info endpoint working!"
          else
            echo "âš ï¸ Info endpoint issue, but deployment completed"
          fi
      
      - name: ğŸ“Š Deployment summary
        run: |
          echo "## ğŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Detail | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸŒ **Service URL** | [${{ env.SERVICE_URL }}](${{ env.SERVICE_URL }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”§ **Service Name** | ${{ env.APP_RUNNER_SERVICE_NAME }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸŒ **AWS Region** | ${{ env.AWS_REGION }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“… **Deployed At** | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”„ **Deployment Type** | ${{ env.deployment-type }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ§ª Quick Tests:" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ”— [Health Check](${{ env.SERVICE_URL }}/api/health)" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“‹ [Service Info](${{ env.SERVICE_URL }}/api/info)" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“¦ [API Docs](${{ env.SERVICE_URL }}/api/pedidos)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ‰ **Your microservice is now live!**" >> $GITHUB_STEP_SUMMARY

  # Job: Notificar resultado
  notify:
    name: ğŸ“¢ Notify Deployment Result
    runs-on: ubuntu-latest
    needs: [check-deploy, deploy]
    if: always()
    
    steps:
      - name: ğŸ“¢ Deployment Success
        if: needs.deploy.result == 'success'
        run: |
          echo "ğŸ‰ Deployment completed successfully!"
          echo "ğŸŒ Service is now available at the provided URL"
          echo "ğŸ“Š Check the deployment summary for details"
      
      - name: ğŸ“¢ Deployment Skipped
        if: needs.check-deploy.outputs.should-deploy == 'false'
        run: |
          echo "â­ï¸ Deployment skipped"
          echo "ğŸ” Reason: Quality gate did not pass or conditions not met"
          echo "ğŸ’¡ Ensure your PR passes all quality checks before merging"
      
      - name: ğŸ“¢ Deployment Failed
        if: needs.deploy.result == 'failure'
        run: |
          echo "âŒ Deployment failed"
          echo "ğŸ” Check the deployment logs for details"
          echo "ğŸ’¡ Common issues: AWS credentials, service configuration, or application errors"
          exit 1

