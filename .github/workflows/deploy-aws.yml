name: üöÄ Deploy to AWS

on:
  push:
    branches: [ main, master ]
  workflow_run:
    workflows: ["üîç PR Quality Check"]
    types:
      - completed
    branches: [ main, master ]

# Permiss√µes necess√°rias
permissions:
  contents: read
  actions: read
  checks: read

env:
  AWS_REGION: us-east-1
  APP_RUNNER_SERVICE_NAME: pedidos-microservice
  ECR_REPOSITORY: pedidos-microservice

jobs:
  # Job: Verificar se deve fazer deploy
  check-deploy:
    name: üîç Check Deploy Conditions
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    outputs:
      should-deploy: ${{ steps.check.outputs.should-deploy }}
      quality-passed: ${{ steps.quality.outputs.passed }}
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
      
      - name: üîç Check quality gate
        id: quality
        run: |
          # Se foi triggered por workflow_run, verificar se passou
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            if [ "${{ github.event.workflow_run.conclusion }}" = "success" ]; then
              echo "‚úÖ Quality gate passed"
              echo "passed=true" >> $GITHUB_OUTPUT
            else
              echo "‚ùå Quality gate failed"
              echo "passed=false" >> $GITHUB_OUTPUT
            fi
          else
            # Push direto na main (assumir que passou)
            echo "üîÑ Direct push to main, assuming quality passed"
            echo "passed=true" >> $GITHUB_OUTPUT
          fi
      
      - name: üéØ Determine if should deploy
        id: check
        run: |
          QUALITY_PASSED="${{ steps.quality.outputs.passed }}"
          
          if [ "$QUALITY_PASSED" = "true" ]; then
            echo "‚úÖ All conditions met for deployment"
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Conditions not met for deployment"
            echo "should-deploy=false" >> $GITHUB_OUTPUT
          fi

  # Job: Verificar secrets AWS
  check-secrets:
    name: üîç Check AWS Secrets
    runs-on: ubuntu-latest
    needs: check-deploy
    if: needs.check-deploy.outputs.should-deploy == 'true'
    
    outputs:
      secrets-configured: ${{ steps.verify.outputs.configured }}
    
    steps:
      - name: üîç Verify AWS secrets are configured
        id: verify
        run: |
          echo "üîç Checking AWS secrets configuration..."
          
          if [ -z "$AWS_ACCESS_KEY_ID" ]; then
            echo "‚ùå AWS_ACCESS_KEY_ID secret not configured"
            echo "configured=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          if [ -z "$AWS_SECRET_ACCESS_KEY" ]; then
            echo "‚ùå AWS_SECRET_ACCESS_KEY secret not configured"
            echo "configured=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          if [ -z "$AWS_ACCOUNT_ID" ]; then
            echo "‚ùå AWS_ACCOUNT_ID secret not configured"
            echo "configured=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "‚úÖ All AWS secrets are configured"
          echo "configured=true" >> $GITHUB_OUTPUT
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}

  # Job: Build e Deploy via ECR + App Runner
  deploy:
    name: üöÄ Deploy to AWS App Runner
    runs-on: ubuntu-latest
    needs: [check-deploy, check-secrets]
    if: needs.check-deploy.outputs.should-deploy == 'true' && needs.check-secrets.outputs.secrets-configured == 'true'
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
      
      - name: üîß Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: üê≥ Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: üìÅ Create necessary directories
        run: |
          mkdir -p src/database
          chmod 755 src/database
      
      - name: üèóÔ∏è Build and push Docker image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "üèóÔ∏è Building Docker image..."
          
          # Criar ECR repository se n√£o existir
          aws ecr describe-repositories --repository-names $ECR_REPOSITORY --region $AWS_REGION || \
          aws ecr create-repository --repository-name $ECR_REPOSITORY --region $AWS_REGION
          
          # Build da imagem
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:latest .
          
          # Push da imagem
          echo "üì§ Pushing image to ECR..."
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          
          # Salvar URI da imagem
          echo "IMAGE_URI=$ECR_REGISTRY/$ECR_REPOSITORY:latest" >> $GITHUB_ENV
      
      - name: üöÄ Create or Update App Runner Service
        run: |
          echo "üöÄ Deploying to AWS App Runner..."
          
          SERVICE_ARN="arn:aws:apprunner:${{ env.AWS_REGION }}:${{ secrets.AWS_ACCOUNT_ID }}:service/${{ env.APP_RUNNER_SERVICE_NAME }}"
          
          # Verificar se o servi√ßo j√° existe
          if aws apprunner describe-service --service-arn "$SERVICE_ARN" 2>/dev/null; then
            echo "üîÑ Service exists, updating..."
            
            # Atualizar servi√ßo existente
            aws apprunner start-deployment --service-arn "$SERVICE_ARN"
            echo "deployment-type=update" >> $GITHUB_ENV
            
          else
            echo "üÜï Creating new App Runner service..."
            
            # Criar configura√ß√£o do servi√ßo
            cat > apprunner-service.json << EOF
          {
            "ServiceName": "${{ env.APP_RUNNER_SERVICE_NAME }}",
            "SourceConfiguration": {
              "ImageRepository": {
                "ImageIdentifier": "${{ env.IMAGE_URI }}",
                "ImageConfiguration": {
                  "Port": "5000",
                  "RuntimeEnvironmentVariables": {
                    "FLASK_ENV": "production",
                    "PORT": "5000",
                    "SQLALCHEMY_DATABASE_URI": "sqlite:////tmp/db/pedidos_production.db"
                  }
                },
                "ImageRepositoryType": "ECR"
              },
              "AutoDeploymentsEnabled": false
            },
            "InstanceConfiguration": {
              "Cpu": "0.25 vCPU",
              "Memory": "0.5 GB"
            }
          }
          EOF
            
            # Criar servi√ßo
            aws apprunner create-service --cli-input-json file://apprunner-service.json
            echo "deployment-type=create" >> $GITHUB_ENV
          fi
      
      - name: ‚è≥ Wait for deployment
        run: |
          echo "‚è≥ Waiting for deployment to complete..."
          
          SERVICE_ARN="arn:aws:apprunner:${{ env.AWS_REGION }}:${{ secrets.AWS_ACCOUNT_ID }}:service/${{ env.APP_RUNNER_SERVICE_NAME }}"
          
          # Aguardar at√© o servi√ßo estar rodando
          for i in {1..20}; do
            STATUS=$(aws apprunner describe-service --service-arn "$SERVICE_ARN" --query 'Service.Status' --output text 2>/dev/null || echo "UNKNOWN")
            echo "üîÑ Deployment status: $STATUS (attempt $i/20)"
            
            if [ "$STATUS" = "RUNNING" ]; then
              echo "‚úÖ Deployment completed successfully!"
              break
            elif [ "$STATUS" = "CREATE_FAILED" ] || [ "$STATUS" = "UPDATE_FAILED" ]; then
              echo "‚ùå Deployment failed with status: $STATUS"
              
              # Obter logs de erro
              echo "üîç Getting error details..."
              aws apprunner describe-service --service-arn "$SERVICE_ARN" --query 'Service.Status' || true
              exit 1
            fi
            
            sleep 30
          done
          
          if [ "$STATUS" != "RUNNING" ]; then
            echo "‚è∞ Deployment timeout - status: $STATUS"
            echo "üîç Check AWS Console for details"
            exit 1
          fi
      
      - name: üåê Get service URL
        id: url
        run: |
          SERVICE_ARN="arn:aws:apprunner:${{ env.AWS_REGION }}:${{ secrets.AWS_ACCOUNT_ID }}:service/${{ env.APP_RUNNER_SERVICE_NAME }}"
          
          SERVICE_URL=$(aws apprunner describe-service --service-arn "$SERVICE_ARN" --query 'Service.ServiceUrl' --output text 2>/dev/null || echo "")
          
          if [ -n "$SERVICE_URL" ]; then
            echo "üåê Service URL: https://$SERVICE_URL"
            echo "url=https://$SERVICE_URL" >> $GITHUB_OUTPUT
            echo "SERVICE_URL=https://$SERVICE_URL" >> $GITHUB_ENV
          else
            echo "‚ö†Ô∏è Could not retrieve service URL"
            echo "SERVICE_URL=unknown" >> $GITHUB_ENV
          fi
      
      - name: üß™ Test deployed application
        run: |
          echo "üß™ Testing deployed application..."
          
          if [ "$SERVICE_URL" != "unknown" ] && [ -n "$SERVICE_URL" ]; then
            # Aguardar um pouco para o servi√ßo estar totalmente dispon√≠vel
            echo "‚è≥ Waiting for service to be fully available..."
            sleep 60
            
            # Testar health check
            echo "üîç Testing health endpoint..."
            if curl -f "$SERVICE_URL/api/health" --max-time 30 2>/dev/null; then
              echo "‚úÖ Health check passed!"
            else
              echo "‚ö†Ô∏è Health check failed, but deployment completed"
            fi
            
            # Testar endpoint de info
            echo "üîç Testing info endpoint..."
            if curl -f "$SERVICE_URL/api/info" --max-time 30 2>/dev/null; then
              echo "‚úÖ Info endpoint working!"
            else
              echo "‚ö†Ô∏è Info endpoint issue, but deployment completed"
            fi
          else
            echo "‚ö†Ô∏è Skipping tests - service URL not available"
          fi
      
      - name: üìä Deployment summary
        run: |
          echo "## üöÄ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ‚úÖ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Detail | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| üåê **Service URL** | [${{ env.SERVICE_URL }}](${{ env.SERVICE_URL }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| üîß **Service Name** | ${{ env.APP_RUNNER_SERVICE_NAME }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üåç **AWS Region** | ${{ env.AWS_REGION }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üìÖ **Deployed At** | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "| üîÑ **Deployment Type** | ${{ env.deployment-type }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üê≥ **Image URI** | ${{ env.IMAGE_URI }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üß™ Quick Tests:" >> $GITHUB_STEP_SUMMARY
          echo "- üîó [Health Check](${{ env.SERVICE_URL }}/api/health)" >> $GITHUB_STEP_SUMMARY
          echo "- üìã [Service Info](${{ env.SERVICE_URL }}/api/info)" >> $GITHUB_STEP_SUMMARY
          echo "- üì¶ [API Docs](${{ env.SERVICE_URL }}/api/pedidos)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üéâ **Your microservice is now live!**" >> $GITHUB_STEP_SUMMARY

  # Job: Notificar resultado
  notify:
    name: üì¢ Notify Deployment Result
    runs-on: ubuntu-latest
    needs: [check-deploy, check-secrets, deploy]
    if: always()
    
    steps:
      - name: üì¢ Deployment Success
        if: needs.deploy.result == 'success'
        run: |
          echo "üéâ Deployment completed successfully!"
          echo "üåê Service is now available at the provided URL"
          echo "üìä Check the deployment summary for details"
      
      - name: üì¢ Secrets Missing
        if: needs.check-secrets.outputs.secrets-configured == 'false'
        run: |
          echo "‚ùå Deployment failed: AWS secrets not configured"
          echo "üîç Please configure the following secrets in GitHub:"
          echo "   - AWS_ACCESS_KEY_ID"
          echo "   - AWS_SECRET_ACCESS_KEY"
          echo "   - AWS_ACCOUNT_ID"
          echo "üîó Go to: https://github.com/${{ github.repository }}/settings/secrets/actions"
          exit 1
      
      - name: üì¢ Deployment Skipped
        if: needs.check-deploy.outputs.should-deploy == 'false'
        run: |
          echo "‚è≠Ô∏è Deployment skipped"
          echo "üîç Reason: Quality gate did not pass or conditions not met"
          echo "üí° Ensure your PR passes all quality checks before merging"
      
      - name: üì¢ Deployment Failed
        if: needs.deploy.result == 'failure'
        run: |
          echo "‚ùå Deployment failed"
          echo "üîç Check the deployment logs for details"
          echo "üí° Common issues: AWS credentials, service configuration, or application errors"
          exit 1

