name: ğŸ” AWS Deploy Debug

on:
  workflow_dispatch:  # Permite execuÃ§Ã£o manual
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/deploy-aws.yml'
      - 'apprunner.yaml'

jobs:
  debug-secrets:
    name: ğŸ” Debug AWS Secrets Configuration
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Check GitHub Secrets Configuration
        run: |
          echo "ğŸ” Checking GitHub Secrets configuration..."
          echo ""
          
          # Verificar se secrets existem (sem mostrar valores)
          if [ -z "$AWS_ACCESS_KEY_ID" ]; then
            echo "âŒ AWS_ACCESS_KEY_ID secret not configured"
            echo "ğŸ’¡ Please add AWS_ACCESS_KEY_ID to GitHub repository secrets"
            SECRET_MISSING=true
          else
            echo "âœ… AWS_ACCESS_KEY_ID secret is configured"
            echo "ğŸ“ Length: ${#AWS_ACCESS_KEY_ID} characters"
          fi
          
          if [ -z "$AWS_SECRET_ACCESS_KEY" ]; then
            echo "âŒ AWS_SECRET_ACCESS_KEY secret not configured"
            echo "ğŸ’¡ Please add AWS_SECRET_ACCESS_KEY to GitHub repository secrets"
            SECRET_MISSING=true
          else
            echo "âœ… AWS_SECRET_ACCESS_KEY secret is configured"
            echo "ğŸ“ Length: ${#AWS_SECRET_ACCESS_KEY} characters"
          fi
          
          if [ -z "$AWS_ACCOUNT_ID" ]; then
            echo "âŒ AWS_ACCOUNT_ID secret not configured"
            echo "ğŸ’¡ Please add AWS_ACCOUNT_ID to GitHub repository secrets"
            SECRET_MISSING=true
          else
            echo "âœ… AWS_ACCOUNT_ID secret is configured"
            echo "ğŸ“ Length: ${#AWS_ACCOUNT_ID} characters"
          fi
          
          echo ""
          echo "ğŸ”§ Repository Information:"
          echo "Repository: ${{ github.repository }}"
          echo "Repository Owner: ${{ github.repository_owner }}"
          echo "Actor: ${{ github.actor }}"
          echo "Event: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          
          if [ "$SECRET_MISSING" = "true" ]; then
            echo ""
            echo "âŒ Some secrets are missing. Please configure them at:"
            echo "https://github.com/${{ github.repository }}/settings/secrets/actions"
            exit 1
          fi
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}

      - name: ğŸ§ª Test AWS Credentials
        if: ${{ secrets.AWS_ACCESS_KEY_ID }}
        run: |
          echo "ğŸ§ª Testing AWS credentials..."
          
          # Instalar AWS CLI se nÃ£o estiver disponÃ­vel
          if ! command -v aws &> /dev/null; then
            echo "ğŸ“¦ Installing AWS CLI..."
            curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
            unzip awscliv2.zip
            sudo ./aws/install
          fi
          
          # Configurar AWS CLI
          aws configure set aws_access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws configure set aws_secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws configure set default.region us-east-1
          
          # Testar credenciais
          echo "ğŸ” Testing AWS STS (Security Token Service)..."
          if aws sts get-caller-identity; then
            echo "âœ… AWS credentials are valid!"
          else
            echo "âŒ AWS credentials are invalid or insufficient permissions"
            exit 1
          fi
          
          echo ""
          echo "ğŸ” Testing App Runner permissions..."
          if aws apprunner list-services --region us-east-1 > /dev/null 2>&1; then
            echo "âœ… App Runner permissions are working!"
          else
            echo "âš ï¸ App Runner permissions may be insufficient"
            echo "ğŸ’¡ Make sure your IAM user has AppRunnerFullAccess policy"
          fi

      - name: ğŸ“‹ Generate Troubleshooting Report
        if: always()
        run: |
          echo "ğŸ“‹ TROUBLESHOOTING REPORT"
          echo "========================"
          echo ""
          echo "ğŸ”§ Common Solutions:"
          echo ""
          echo "1. ğŸ“ Add secrets to GitHub repository:"
          echo "   Go to: https://github.com/${{ github.repository }}/settings/secrets/actions"
          echo "   Add these secrets:"
          echo "   - AWS_ACCESS_KEY_ID (your AWS access key)"
          echo "   - AWS_SECRET_ACCESS_KEY (your AWS secret key)"
          echo "   - AWS_ACCOUNT_ID (your 12-digit AWS account ID)"
          echo ""
          echo "2. ğŸ”‘ Create AWS IAM User:"
          echo "   - Go to AWS Console > IAM > Users"
          echo "   - Create new user with programmatic access"
          echo "   - Attach policy: AppRunnerFullAccess"
          echo "   - Copy Access Key ID and Secret Access Key"
          echo ""
          echo "3. ğŸ¢ For Organization repositories:"
          echo "   - Check if organization allows secrets"
          echo "   - May need organization admin approval"
          echo ""
          echo "4. ğŸ”„ If secrets were just added:"
          echo "   - Wait 1-2 minutes for propagation"
          echo "   - Re-run the workflow"
          echo ""
          echo "5. ğŸ“± Verify secret names exactly match:"
          echo "   - AWS_ACCESS_KEY_ID (not aws_access_key_id)"
          echo "   - AWS_SECRET_ACCESS_KEY (not aws_secret_access_key)"
          echo "   - AWS_ACCOUNT_ID (not aws_account_id)"
          echo ""
          echo "ğŸ†˜ If still having issues:"
          echo "   - Check AWS IAM user permissions"
          echo "   - Verify AWS account is active"
          echo "   - Try creating new access keys"
          echo "   - Contact AWS support if needed"

  test-without-secrets:
    name: ğŸ§ª Test Workflow Without AWS
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "âš ï¸ requirements.txt not found, installing basic dependencies"
            pip install flask flask-sqlalchemy flask-cors
          fi

      - name: ğŸ§ª Run basic tests
        run: |
          echo "ğŸ§ª Running basic application tests..."
          python -c "
          import sys
          sys.path.append('src')
          try:
              from main import app
              print('âœ… Application imports successfully')
              with app.test_client() as client:
                  response = client.get('/api/health')
                  if response.status_code == 200:
                      print('âœ… Health endpoint working')
                  else:
                      print(f'âš ï¸ Health endpoint returned: {response.status_code}')
          except Exception as e:
              print(f'âŒ Application test failed: {e}')
              print('ğŸ’¡ This is normal if you have not configured the database yet')
          "

      - name: ğŸ“Š Application Status
        run: |
          echo "ğŸ“Š APPLICATION STATUS REPORT"
          echo "============================"
          echo ""
          echo "âœ… Code checkout: Success"
          echo "âœ… Python setup: Success"
          echo "âœ… Dependencies: Success"
          echo "âœ… Basic tests: Completed"
          echo ""
          echo "ğŸ¯ Next step: Configure AWS secrets for deployment"
          echo "ğŸ“ Follow the troubleshooting guide above"
          echo ""
          echo "ğŸ”— Configure secrets at:"
          echo "https://github.com/${{ github.repository }}/settings/secrets/actions"

